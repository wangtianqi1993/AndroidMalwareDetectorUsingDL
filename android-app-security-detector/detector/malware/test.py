import os
from operator import itemgetter

from androguard.core import androconf
from androguard.core.bytecodes import apk


def main():
    malware_path = '/home/kevin/Temps/android-security/samples'
    permission_dict = {}
    app_count = 0
    for root, dirs, files in os.walk(malware_path, followlinks=True):
            if files:
                for f in files:
                    real_filename = root
                    if real_filename[-1] != "/":
                        real_filename += "/"
                    real_filename += f
                    ret_type = androconf.is_android(real_filename)
                    if ret_type == "APK":
                        # print os.path.basename(real_filename), ":"
                        app_count += 1
                        try:
                            a = apk.APK(real_filename)
                            if a.is_valid_APK():
                                permissions = a.get_requested_permissions()
                                temp_permissions = []
                                for per in permissions:
                                    if per not in temp_permissions:
                                        if per in permission_dict:
                                            permission_dict[per] += 1
                                        else:
                                            permission_dict[per] = 1
                                        temp_permissions.append(per)
                            else:
                                print "INVALID"
                        except Exception, e:
                            print "ERROR", e
            else:
                print "directory not exists!!!"

    permission_dict = sorted(permission_dict.items(), key=itemgetter(1))
    for key in permission_dict:
        print key
    print(app_count)


if __name__ == '__main__':
    main()
